@page
@model NLI_POS.Pages.Orders.DetailsModel

@{
    ViewData["Title"] = "Order Details";
}
<div class="container bg-white bg-gradient shadow p-4 ">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-primary"><i class="fas fa-file-invoice me-2"></i> Order Details</h4>
        <i class="fas fa-window-close fa-2xl text-danger cursor-pointer" title="Close" onclick="window.location = './Index';"></i>
    </div>
    <hr />
    <div class="row">
        <div class="col-sm-6 form-group">
            <span class="form-label">@Html.DisplayNameFor(model => model.Order.OrderNo)</span>
            <span class="form-control">@Html.DisplayFor(model => model.Order.OrderNo)</span>
        </div>
        <div class="col-sm-3 form-group">
            @Html.DisplayNameFor(model => model.Order.OrderDate)
            <span class="form-control">@Html.DisplayFor(model => model.Order.OrderDate)</span>
        </div>
        <div class="col-sm-3">
            @Html.DisplayNameFor(model => model.Order.Office)
            <span class="form-control">@Html.DisplayFor(model => model.Order.Office.Name)</span>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-9">
            Customer
            <span class="form-control">@Html.DisplayFor(model => model.Order.Customers.CustCode) | @Html.DisplayFor(model => model.Order.Customers.FirstName) @Html.DisplayFor(model => model.Order.Customers.LastName)</span>
        </div>
        <div class="col-sm-3">
            @Html.DisplayNameFor(model => model.Order.Customers.CustClass)
            <span class="form-control">@Html.DisplayFor(model => model.Order.Customers.CustClasses.Name) </span>
        </div>
    </div>

    <div>
        <br />
        @* <partial name="_OrderDetailsPartial" model="Model.OrderList"></partial> *@
        <partial name="_OrderDetailsPartial" model="Model.OrderSummary" />

    </div>

    <div class="row p-3">
        @Html.DisplayNameFor(model => model.Order.Notes)
        <textarea class="form-control" asp-for="Order.Notes" rows="3" readonly></textarea>
    </div>
    <div class="row d-flex justify-content-between align-items-center">
        <div class="col-auto">
            <a class="btn btn-primary bg-gradient" asp-page="./Index">
                <i class="fas fa-chevron-circle-left"></i> Back to List
            </a>
        </div>

        <div class="col-auto d-flex justify-content-end">
            @if (!Model.Order.IsVoided)
            {
                @*                 <form method="post" onsubmit="return validateAndShowLoader(this)" asp-page-handler="Void" onsubmit="return confirm('Are you sure you want to void this order?');" class="me-2">
            <input type="hidden" asp-for="Order.OrderNo" />
            <button type="submit" class="btn btn-danger">
            <i class="fas fa-ban"></i> Void Order
            </button>
            </form> *@
                <!-- Void Button -->
                <button type="button"
                        class="btn btn-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#voidOrderModal"
                        data-orderno="@Model.Order.OrderNo"
                        data-customer="@Model.Order.Customers.FirstName @Model.Order.Customers.LastName">
                    <i class="fas fa-ban me-2"></i> Void Order
                </button>
                <a class="btn btn-success bg-gradient ms-2" data-bs-toggle="modal" data-bs-target="#printReceipt">
                    <i class="fas fa-eye me-2"></i> View Receipt
                </a>
            }
            else
            {
                <span class="badge bg-danger fs-6 align-self-center p-2 me-2">VOIDED</span>
            }
        </div>
    </div>

</div>

<!-- Modal Receipt -->
<div class="modal fade" id="printReceipt" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="printReceiptLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div id="printableOrderDetails" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="printReceiptLabel">Receipt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row pb-3">
                    <div class="col-9">
                        <img src="~/images/nli-logo.png" width="200px" /><br />
                        <h5>We care for you <i>naturally</i>!</h5><br />
                        <h4>Purchase Order Receipt</h4>
                        <span > ORDER NO: @Model.Order.OrderNo</span><br />
                        <span> DATE: @Model.Order.OrderDate.ToString("MMMM dd, yyyy")</span><br />
                        <span> CUSTOMER: @Model.Order.Customers.FirstName @Model.Order.Customers.LastName </span><br />
                    </div>
                    <div class="col-3 small justify-content-end">
                        <span class="small"> Address: @Model.Order.Office.Address </span><br />
                        <span class="small text-nowrap"> Email: @Model.Order.Office.Email</span><br />
                        <span class="small"> Contact No: @Model.Order.Office.ContactNo</span>
                    </div>
                </div>

                @* Details here *@
                <partial name="_OrderDetailsPartial" model="Model.OrderSummary"></partial>

                <div class="row">
                    <div class="col-8 small"><span class="small fst-italic">NOTE: This is a computer generated purchase order, hence no signature is required.</span></div>
                    <div class="col-4 text-end">CASHIER: @User.FindFirst("FullName")?.Value</div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-chevron-left"></i> Close</button>
                <button type="button" class="btn btn-info" onclick="printModal();"><i class="fas fa-print"></i> Print</button>
                @* <button type="button" class="btn btn-success" onclick="emailModal()"><i class="fas fa-paper-plane"></i> Email</button> *@
                <button type="button" data-orderno="@Model.Order.OrderNo" data-customer="@Model.Order.Customers.FirstName @Model.Order.Customers.LastName"
                        class="btn btn-success" onclick="sendEmail(this)">
                    <i class="fas fa-paper-plane"></i> Email
                </button>
            </div>
        </div>
    </div>

</div>

<!-- Void Confirmation Modal -->
<div class="modal fade" id="voidOrderModal" tabindex="-1" aria-labelledby="voidOrderLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" asp-page-handler="Void" onsubmit="return validateAndShowLoader(this)">
            @Html.AntiForgeryToken()
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="voidOrderLabel">Confirm Void</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-7x text-warning mb-5"></i>
                        <p class="text-center border-top">
                            <h4>Are you sure you want to void this order?</h4>
                            <input type="hidden" id="voidOrderNo" name="OrderNo" />

                            <!-- Optional text display areas -->
                            <h5>
                                Customer: <span id="voidCustomerName"></span><br />
                                Order No: <span id="voidCustOrderNo"></span>
                            </h5>
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Confirm Void</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const voidModal = document.getElementById('voidOrderModal');

        if (voidModal) {
            voidModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const orderNo = button.getAttribute('data-orderno');
                const customerName = button.getAttribute('data-customer');

                const orderNoInput = document.getElementById('voidOrderNo');
                const customerNameDisplay = document.getElementById('voidCustomerName');
                const orderNoDisplay = document.getElementById('voidCustOrderNo');

                if (orderNoInput) {
                    orderNoInput.value = orderNo;
                }

                if (customerNameDisplay) {
                    customerNameDisplay.textContent = customerName;
                }

                if (orderNoDisplay) {
                    orderNoDisplay.textContent = orderNo;
                }

                console.log("Order No:", orderNo);
            });
        }
    });

           function buildEmailHtml(orderNo, date, customerName, items, payments, change) {
            let html = `
        <div style="font-family: Arial, sans-serif; color: #333; max-width: 700px; margin: auto; border: 1px solid #ccc; padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex-shrink: 0; margin-right: 20px;">
                <img src="https://pos.ournoblelife.com/images/nli-logo.png" style="width: 200px;" />
            <p style="margin: 5px 0 0; font-style: italic;">We care for you <strong>naturally</strong>!</p>
        </div>
        <div style="font-size: 12px; text-align: right; line-height: 1.5;">
            <p style="margin: 0;">Bay 9 St. Anthony Bldg.</p>
            <p style="margin: 0;">891 Aurora Blvd. Cubao, Quezon City 1109</p>
            <p style="margin: 0;">Email: <a href="mailto:wecare@ournoblelife.com">wecare@ournoblelife.com</a></p>
            <p style="margin: 0;">+63 917 828 0696</p>
        </div>
    </div>


            <h2 style="margin-top: 20px;">Purchase Order Receipt</h2>
            <p><strong>Order No:</strong> ${orderNo}<br>
            <strong>Date:</strong> ${date}<br>
            <strong>Customer:</strong> ${customerName}</p>

            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead style="background-color: #f2f2f2;">
                    <tr>
                        <th style="border: 1px solid #ccc; padding: 8px;">#</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Category</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Item</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Combo</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Price</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Qty</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody>`;

            items.forEach((item, i) => {
                html += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;">${i + 1}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${item.category}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${item.name}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${item.combo}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${item.price}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${item.qty}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${item.amount}</td>
                    </tr>`;
            });

            html += `</tbody></table>`;

            // Payments section
            html += `<h3 style="margin-top: 30px;">Payment Summary</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background-color: #f2f2f2;">
                    <tr>
                        <th style="border: 1px solid #ccc; padding: 8px;">Payment Method</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody>`;

            payments.forEach(p => {
                html += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;">${p.method}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${p.amount}</td>
                    </tr>`;
            });

            html += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">Change</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: right; font-weight: bold;">${change}</td>
                    </tr>
                </tbody>
            </table>

            <p style="font-size: 12px; margin-top: 30px; font-style: italic; color: #666;">
                NOTE: This is a computer-generated receipt. No signature is required.
            </p>

            <p style="text-align: right; font-weight: bold;">Cashier: System Admin</p>
        </div>`;

            return html;
        }


               function sendEmail(button) {
                const orderNo = button.getAttribute('data-orderno');
                const customerName = button.getAttribute('data-customer');
                const date = new Date().toLocaleDateString('en-PH', { year: 'numeric', month: 'long', day: 'numeric' });

                // Extract product rows
                const items = [];
                document.querySelectorAll('#cartTable tbody tr').forEach(row => {
                    const cols = row.querySelectorAll('td');
                    if (cols.length >= 7) {
                        items.push({
                            category: cols[1].textContent.trim(),
                            name: cols[2].textContent.trim(),
                            combo: cols[3].textContent.trim(),
                            price: cols[4].textContent.trim(),
                            qty: cols[5].textContent.trim(),
                            amount: cols[6].textContent.trim()
                        });
                    }
                });

@*                         const productItems  = [];
                    document.querySelectorAll('#productTableBody tr').forEach(row => {
            const cols = row.querySelectorAll('td');
            if (cols.length >= 7) {
                    productItems .push({
                    category: cols[1].textContent.trim(),
                    name: cols[2].textContent.trim(),
                    combo: cols[3].textContent.trim(),
                    price: cols[4].textContent.trim(),
                    qty: cols[5].textContent.trim(),
                    amount: cols[6].textContent.trim()
                });
            }
        }); *@


    // Extract payment rows (text-based)
    const payments = [];
    document.querySelectorAll('#paymentTableBody tr[data-payment]').forEach(row => {
        const cells = row.querySelectorAll('td');
        const method = cells[5]?.textContent.trim() || '';
        const amount = cells[6]?.textContent.trim() || '';
        if (method && amount) {
            payments.push({ method, amount });
        }
    });



                // Get grand total and total paid to calculate change
                const grandText = document.getElementById("grandTotal")?.textContent?.replace(/[^\d.-]/g, '') || "0";
                const grandTotal = parseFloat(grandText);

                let paidTotal = 0;
                payments.forEach(p => {
                    const amt = parseFloat(p.amount.replace(/,/g, '')) || 0;
                    paidTotal += amt;
                });

                const change = (paidTotal - grandTotal).toFixed(2);

                // Build email body
                const html = buildEmailHtml(orderNo, date, customerName, items, payments, change);
                const email = prompt("Enter recipient email:");
                if (!email) return;

                // Send to backend
                fetch('?handler=EmailModal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({ email, html })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            toastr.success("Email sent!");
                        } else {
                            toastr.error("Failed to send: " + data.error);
                        }
                    });
            }


</script>
