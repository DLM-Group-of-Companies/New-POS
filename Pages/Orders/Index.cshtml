@page
@model NLI_POS.Pages.Orders.IndexModel

@{
    ViewData["Title"] = "Order";
}

<div class="container-fluid bg-white bg-gradient shadow p-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-primary">
            <i class="fas fa-th-list"></i> Orders
        </h4>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = '../Index';"></i>
    </div>
    <hr />
    <p>
        <a class="btn btn-primary btn-gradient" asp-page="New"><i class="fas fa-cart-plus"></i> New Order</a>
    </p>

    <table id="ordersTable" class="table table-striped table-sm">
        <thead class="table-primary">
            <tr>
                <th>Order No</th>
                <th>Order Date</th>
                <th>Customer</th>
                <th>Office</th>
                <th>Total Amount</th>
                <th class="no-export">Actions</th>
            </tr>
        </thead>
    </table>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // Globally override default DataTables button classes
            $.extend(true, $.fn.dataTable.Buttons.defaults, {
                dom: {
                    button: {
                        className: 'btn btn-sm btn-outline-primary' // or any Bootstrap class
                    }
                }
            });

            const exportCommon = {
                exportOptions: {
                    columns: ':not(.no-export)' // Exclude Actions column
                },
                title: 'Orders Report',
                pageSize: 'A4'
            };

            $('#ordersTable').DataTable({
                ajax: {
                    url: '@Url.Page("Index", "Orders")', // Points to OnGetOrders
                    dataSrc: 'data'
                },
                columns: [
                    { data: 'orderNo' },
                    {
                        data: 'orderDate',
                        render: function (data, type, row) {
                            return new Date(data).toLocaleDateString('en-CA'); // outputs YYYY-MM-DD
                        }
                    },
                    { data: 'customerName' },
                    { data: 'office' },
                    {
                        data: 'totAmount',
                        className: 'text-end',
                        render: function (data, type, row) {
                            return parseFloat(data).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        }
                    },
                    {
                        data: 'orderNo',
                        render: function (data) {
                            return `
                                                                <a class="btn btn-success btn-sm m-1" href="/Orders/Edit?orderNo=${data}" title="Edit"><i class="far fa-edit mw-2"></i></a>
                                                                <a class="btn btn-primary btn-sm m-1" href="/Orders/Details?orderNo=${data}" title="Details"><i class="fas fa-info-circle"></i></a>
                                                        <a class="btn btn-danger btn-sm m-1" href="/Orders/Delete?orderNo=${data}" title="Delete"><i class="far fa-trash-alt"></i></a>
                            `;
                        }
                    }
                ],
                columnDefs: [
                    { targets: 5, orderable: false } // Disable sorting Actions column
                ],
                responsive: true,
                dom: 'Bfrtip',
                buttons: [
                    $.extend(true, {}, exportCommon, { extend: 'copy', className: 'btn  btn-outline-primary' }),
                    $.extend(true, {}, exportCommon, { extend: 'csv', className: 'btn  btn-outline-success' }),
                    $.extend(true, {}, exportCommon, { extend: 'excel', className: 'btn  btn-outline-success' }),
                    $.extend(true, {}, exportCommon, { extend: 'pdfHtml5', orientation: 'portrait', className: 'btn  btn-outline-danger' }),
                    $.extend(true, {}, exportCommon, { extend: 'print', className: 'btn  btn-outline-secondary' })
                ],
            });
        });

        // Show loader on AJAX request
        $('#ordersTable').on('preXhr.dt', function () {
            $('#preloader').show();
        });

        // Hide loader when data is loaded
        $('#ordersTable').on('xhr.dt', function () {
            $('#preloader').hide();
        });
    </script>
}