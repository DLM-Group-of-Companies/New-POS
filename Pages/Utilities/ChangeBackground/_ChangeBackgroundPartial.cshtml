@page
@model ChangeModel
@{
    Layout = null;
}

<div>
    <input type="hidden" id="selectedBackground" />
    @Html.AntiForgeryToken()
    <div class="d-flex flex-wrap gap-2" id="background-slider">
        @foreach (var img in Model.ImagePaths)
        {
            <img src="@img" class="bg-thumb" style="width: 150px; height: 100px; cursor: pointer;" />
        }
    </div>

    <div class="mt-3 text-end">
        <button type="button" id="saveBgBtn" class="btn btn-primary">Save Background</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const thumbs = document.querySelectorAll('.bg-thumb');
        const hiddenInput = document.getElementById('selectedBackground');
        const saveButton = document.getElementById('saveBgBtn');

        thumbs.forEach(thumb => {
            thumb.addEventListener('click', function () {
                const imgUrl = this.src;
                document.body.style.backgroundImage = `url('${imgUrl}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';

                hiddenInput.value = imgUrl;
            });
        });

        saveButton.addEventListener('click', function () {
            const selected = hiddenInput.value;
            if (!selected) {
                alert("Please select a background first.");
                return;
            }
            showLoader();
            fetch('/Utilities/ChangeBackground/_ChangeBackgroundPartial?handler=SaveBackground', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ selectedBackground: selected })
            })
                .then(res => {
                    if (res.ok) {
                        hideLoader();
                        alert("Background saved!");
                        var modal = bootstrap.Modal.getInstance(document.getElementById("changebgModal"));
                        modal.hide();
                    } else {
                        hideLoader();
                        alert("Failed to save background.");
                    }
                });
        });
    });
</script>
