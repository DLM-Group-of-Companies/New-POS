@page
@model NLI_POS.Pages.Utilities.AuditLogs.IndexModel

@{
    ViewData["Title"] = "Audit Logs";
}

<div class="container bg-white p-4 shadow">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary mb-0"><i class="fas fa-history me-2"></i>Audit Logs</h2>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = '/';"></i>
    </div>
    <hr />
    <div class="table-responsive">

        <table id="auditLogTable" class="table table-striped table-bordered table-hover table-sm w-100">
            <thead class="table-success">
                <tr>
                    <th>@Html.DisplayNameFor(model => model.AuditLog[0].Timestamp)</th>
                    <th>@Html.DisplayNameFor(model => model.AuditLog[0].User)</th>
                    <th>@Html.DisplayNameFor(model => model.AuditLog[0].Activity)</th>
                    <th>@Html.DisplayNameFor(model => model.AuditLog[0].Path)</th>
                    <th>@Html.DisplayNameFor(model => model.AuditLog[0].IP)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.AuditLog)
                {
                    <tr>
                        <td class="text-nowrap">
                            <small>@item.Timestamp.ToString("yyyy-MM-ddTHH:mm:ssZ")</small>
                        </td>
                        <td><small>@item.User?.UserName</small></td>
                        <td><small>@Html.DisplayFor(modelItem => item.Activity)</small></td>
                        <td>
                            <small>@Html.DisplayFor(modelItem => item.Path)</small>
                        </td>
                        <td>
                            <small>@Html.DisplayFor(modelItem => item.IP)</small>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {

  <script>
    $(document).ready(function () {
        const clientTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        //alert(clientTimeZone);
        // Loop over each row and convert timestamp
        $('#auditLogTable tbody tr').each(function () {
            const $timestampCell = $(this).find('td').eq(0); // first column
            const originalText = $timestampCell.text().trim();

            // Parse the UTC timestamp (assumes it's in ISO or similar format)
            const utcDate = new Date(originalText ); // append 'Z' to force UTC interpretation

            try {
                const localDateString = utcDate.toLocaleDateString('en-CA', {
                    timeZone: clientTimeZone,
                                year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
                });

                $timestampCell.html(`<small>${localDateString}</small>`);
            } catch (e) {
                console.warn('Failed to convert date:', originalText, e);
            }
        });

        // Initialize DataTable
        $('#auditLogTable').DataTable({
            responsive: true,
            ordering: false,
            // order: [[1, 'desc']], // Sort by timestamp column
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search logs..."
            }
        });
    });
</script>

}
