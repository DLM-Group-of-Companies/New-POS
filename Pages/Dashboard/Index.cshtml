@page
@model DashboardModel
@{
    ViewData["Title"] = "Sales Dashboard";
}
<div class="container-fluid bg-dark bg-gradient p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-light mb-0">
            <i class="fas fa-tachometer-alt me-2"></i> Dashboard
        </h3>
        <i class="fas fa-window-close fa-2xl text-light" role="button" title="Close" onclick="window.location = '../Index';"></i>
    </div>
    <hr class="text-light" />
    <div class="row mb-4" id="topKpis">
        <div class="col-md-4 mb-3">
            <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
                <div class="card-body d-flex align-items-center bg-success bg-gradient text-white">
                    <div class="me-3">
                        <i class="fa-solid fa-hand-holding-dollar fa-2xl"></i>
                    </div>
                    <div>
                        <small class="text-uppercase fw-bold opacity-75">Total Sales Today</small>
                        <h3 class="mb-0 fw-bold" id="totalSalesToday">₱0.00</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
                <div class="card-body d-flex align-items-center bg-darkpurple bg-gradient text-white">
                    <div class="me-3">
                        <i class="fa-solid fa-square-poll-horizontal fa-2xl"></i>
                    </div>
                    <div>
                        <small class="text-uppercase fw-bold opacity-75">Orders Today</small>
                        <h3 class="mb-0 fw-bold" id="orderCountToday">₱0.00</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
                <div class="card-body d-flex align-items-center bg-butterscotch bg-gradient text-white">
                    <div class="me-3">
                        <i class="fa-solid fa-scale-balanced fa-2xl"></i>
                    </div>
                    <div>
                        <small class="text-uppercase fw-bold opacity-75">Average Order Value</small>
                        <h3 class="mb-0 fw-bold" id="avgOrderValueToday">₱0.00</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr class="text-light" />

    <form id="filtersForm" class="row mb-4">
        <div class="col-md-3">
            <label asp-for="OfficeId" class="form-label text-light">Office</label>
            <select asp-for="OfficeId" class="form-select form-select-sm" asp-items="ViewBag.Offices">
                @foreach (var office in Model.OfficeList) // assuming it's assigned to your ViewModel
                {
                    <option value="@office.Value"
                            data-locale="@office.Locale"
                            data-currency="@office.CurrencyCode">
                        @office.Text
                    </option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label for="startDate" class="form-label text-light">Start Date</label>
            <input type="date" asp-for="StartDate" class="form-control form-control-sm" />
        </div>

        <div class="col-md-3">
            <label for="endDate" class="form-label text-light">End Date</label>
            <input type="date" asp-for="EndDate" class="form-control form-control-sm" />
        </div>

        <div class="col-md-3 align-self-end">
            <button type="button" id="generateReportBtn" class="btn btn-sm btn-primary w-100">Apply Filters</button>
        </div>
    </form>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="h5 mb-0">Sales Per Products</h2>
                    <div class="btn-group btn-group-sm" role="group" aria-label="Product Type">
                        <button type="button" class="btn btn-outline-primary active" id="btnRegular">Regular</button>
                        <button type="button" class="btn btn-outline-secondary" id="btnPromo">Promo/Package</button>
                    </div>
                </div>
                <canvas id="salesPerProductChart" height="100"></canvas>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <div class="card shadow-sm p-3">
                        <h2 class="h5 mb-3">Top Sales People</h2>
                        <canvas id="topSalespeopleChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-4">
                    <div class="card shadow-sm p-3">
                        <div class="chart-container" style="min-height:200px;">
                            <h2 class="h5 mb-3">Sales Trend</h2>
                            <canvas id="salesTrendChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm p-3">
                <h2 class="h5 mb-3">Top Customers</h2>
                <div style="height: 428px;">
                    <canvas id="topCustomersChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow-sm p-3">
                <h2 class="h5 mb-3">Repeat Customers</h2>
                <div class="small">
                    <table id="repeatCustomersTable" class="table table-striped table-sm ">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Orders</th>
                                <th>Last Order</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        //For currency
        let currencyCode;
        let locale;

        // Initialize on page load
        const officeSelect = document.querySelector('select[name="OfficeId"]');
        const setCurrencyGlobals = () => {
            const selectedOption = officeSelect.options[officeSelect.selectedIndex];
            currencyCode = selectedOption.getAttribute('data-currency');
            locale = selectedOption.getAttribute('data-locale');
        };

        // Run once on load
        setCurrencyGlobals();

        const formatCurrency = (value) => {
            return new Intl.NumberFormat(locale, {
                style: 'currency',
                currency: currencyCode,
                minimumFractionDigits: 2
            }).format(value);
        };

        // Also update when Office changes
        officeSelect.addEventListener('change', setCurrencyGlobals);


        // 🔹 Shared helper: build query params with dates & officeId
        function getQueryParams(extraParams = {}) {
            const startDate = document.getElementById("StartDate")?.value;
            const endDate = document.getElementById("EndDate")?.value;
            const officeId = document.getElementById("OfficeId")?.value;

            const params = new URLSearchParams();
            if (startDate) params.append("StartDate", startDate);
            if (endDate) params.append("EndDate", endDate);
            if (officeId) params.append("OfficeId", officeId);

            // Add extra params if passed in
            for (const [key, value] of Object.entries(extraParams)) {
                params.append(key, value);
            }
            return params.toString();
        }

        // 🔹 Load Top KPIs
        async function loadTopKpis() {
            try {
                const response = await fetch(`?handler=TopKpis&${getQueryParams()}`);
                const data = await response.json();
                // document.getElementById('totalSalesToday').textContent = `₱${data.totalSales.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
                document.getElementById('totalSalesToday').textContent = formatCurrency(data.totalSales);
                document.getElementById('orderCountToday').textContent = data.orderCount;
                document.getElementById('avgOrderValueToday').textContent = formatCurrency(data.averageOrderValue);
            } catch (err) {
                console.error('Failed to load KPIs:', err);
            }
        }

        // 🔹 Load Top Customers Chart
        let topCustomersChartInstance;

        async function loadTopCustomersChart() {
            const response = await fetch(`?handler=TopCustomers&${getQueryParams()}`);
            const data = await response.json();
            const labels = data.map(x => x.customerName);
            const values = data.map(x => x.totalSpent);

            // Calculate height dynamically
            const chartHeight = data.length * 40; // 40px per bar
            const chartEl = document.getElementById('topCustomersChart');
            chartEl.style.height = `${chartHeight}px`;

            // Destroy old chart if exists
            if (topCustomersChartInstance) {
                topCustomersChartInstance.destroy();
            }

            // ✅ Make sure to pass the element or ctx properly
            topCustomersChartInstance = new Chart(chartEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total Spent',
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'nearest', intersect: true },
                    scales: { x: { beginAtZero: true } },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: ctx => {
                                    const settings = getSelectedOfficeSettings();

                                    return new Intl.NumberFormat(settings.locale, {
                                        style: 'currency',
                                        currency: settings.currency
                                    }).format(ctx.raw);
                                }
                            }
                        }
                    }
                }

            });

        }


        // 🔹 Load Repeat Customers Table
        async function loadRepeatCustomersTable() {
            const response = await fetch(`?handler=RepeatCustomers&${getQueryParams()}`);
            const data = await response.json();

            if ($.fn.DataTable.isDataTable('#repeatCustomersTable')) {
                $('#repeatCustomersTable').DataTable().clear().destroy();
            }

            const tbody = document.querySelector('#repeatCustomersTable tbody');
            tbody.innerHTML = data.map(row => `
                                                                <tr>
                                                                    <td>${row.customerName}</td>
                                                                    <td>${row.orderCount}</td>
                                                                    <td>${new Date(row.lastOrder).toLocaleDateString()}</td>
                                                                </tr>
                                                            `).join('');

            $('#repeatCustomersTable').DataTable({
                order: [[1, 'desc']],
                pageLength: 10,
                lengthChange: false,
                searching: false,
                info: false
            });
        }

        // document.getElementById('generateReportBtn').addEventListener('click', loadRepeatCustomersTable);


        // 🔹 Sales Per Product Chart
        document.getElementById('btnRegular').addEventListener('click', function () {
            setActiveButton(this);
            loadSalesChart('regular');
        });

        document.getElementById('btnPromo').addEventListener('click', function () {
            setActiveButton(this);
            loadSalesChart('promo');
        });

        function setActiveButton(button) {
            button.parentNode.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active', 'btn-primary'));
            button.classList.add('active', 'btn-primary');
        }

        let productChart;
        async function loadSalesChart(mode = 'regular') {
            showLoader();
            try {
                const response = await fetch(`?handler=SalesChart&mode=${mode}&${getQueryParams()}`);
                const data = await response.json();
                const labels = data.map(x => x.productName);
                const sales = data.map(x => x.totalSales);
                const backgroundColors = labels.map(name => getProductColor(name));

                if (productChart) productChart.destroy();
                productChart = new Chart(document.getElementById('salesPerProductChart'), {
                    type: 'pie',
                    data: { labels, datasets: [{ data: sales, backgroundColor: backgroundColors, borderColor: '#fff' }] },
                    options: { responsive: true, plugins: { legend: { position: 'right' } } }
                });
            } catch (err) {
                console.error("Failed to load sales chart:", err);
            } finally {
                hideLoader();
            }
        }

        function getProductColor(name) {
            switch (name.toLowerCase()) {
                case 'cryptomonadales': return 'rgba(0, 128, 0, 0.7)';
                case 'cleanse': return 'rgba(255, 165, 0, 0.7)';
                case 'ppars plus': return 'rgba(128, 0, 128, 0.7)';
                case 'coffee': return 'rgba(139, 69, 19, 0.7)';
                default: return getRandomColor();
            }
        }
        function getRandomColor() {
            const r = Math.floor(Math.random() * 155) + 100;
            const g = Math.floor(Math.random() * 155) + 100;
            const b = Math.floor(Math.random() * 155) + 100;
            return `rgba(${r}, ${g}, ${b}, 0.7)`;
        }

        // 🔹 Top Salespeople Chart
        let topSalespeopleChart = null; // store chart instance

        async function loadTopSalespeopleChart() {
            const response = await fetch(`?handler=TopSalespeople&${getQueryParams()}`);
            const data = await response.json();
            const labels = data.map(x => x.salesperson?.trim() || 'UNSPECIFIED');
            const values = data.map(x => x.totalSales);

            // Destroy existing chart before creating a new one
            if (topSalespeopleChart) {
                topSalespeopleChart.destroy();
            }

            // Dynamically adjust height based on rows
            const chartHeight = data.length * 40; // 40px per bar
            const canvas = document.getElementById('topSalespeopleChart');
            canvas.style.height = `${chartHeight}px`;

            topSalespeopleChart = new Chart(document.getElementById('topSalespeopleChart'), {
                type: 'bar',
                data: { labels, datasets: [{ data: values, backgroundColor: 'rgba(255, 159, 64, 0.6)' }] },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: { x: { beginAtZero: true } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => formatCurrency(ctx.raw) } }
                    }
                }
            });
        }

        // 🔹 Sales Trend Chart
        let trendChart;

        async function loadSalesTrend() {
            const response = await fetch(`?handler=SalesTrend&${getQueryParams()}`);
            const data = await response.json();
            const labels = data.map(x => x.date);
            const totals = data.map(x => x.total);

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(document.getElementById("salesTrendChart"), {
                type: 'line',
                data: { labels, datasets: [{ label: 'Total Sales', data: totals, borderColor: 'rgb(126,239,203)', backgroundColor: 'rgba(54, 162, 235, 0.2)', tension: 0.4 }] },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        // 🔹 Unified event bindings
        document.addEventListener("DOMContentLoaded", () => {
            loadTopKpis();
            loadTopCustomersChart();
            loadRepeatCustomersTable();
            loadSalesChart();
            loadTopSalespeopleChart();
            loadSalesTrend();

            document.getElementById("generateReportBtn")?.addEventListener("click", () => {
                loadTopKpis();
                loadTopCustomersChart();
                loadRepeatCustomersTable();
                loadSalesChart();
                loadTopSalespeopleChart();
                loadSalesTrend();
            });
        });
    </script>

    <script>
        function getSelectedOfficeSettings() {
            const office = document.querySelector('#OfficeId option:checked');
            return {
                locale: office.dataset.locale,
                currency: office.dataset.currency
            };
        }
    </script>
}
