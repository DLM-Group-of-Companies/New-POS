@using static NLI_POS.Services.AuditHelpers
@model NLI_POS.Models.ViewModels.OrderSummaryViewModel
@{
    var idPrefix = ViewData["IdPrefix"]?.ToString() ?? "default";
    var culture = (System.Globalization.CultureInfo)ViewData["Culture"];
}

<div class="table-responsive">
    <table id="@($"{idPrefix}_cartTable")" class="table table-bordered table-hover shadow-sm rounded bg-white small">
        <thead class="table-primary text-center">
            <tr>
                <th>Item #</th>
                <th>Category</th>
                <th>Item(s)</th>
                <th>Sub-Item(s)</th>
                <th class="text-end">Price</th>
                <th class="text-end">Qty</th>
                <th class="text-end">Amount</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="@($"{idPrefix}_productTableBody")">
            @if (Model.ProductItems != null && Model.ProductItems.Any())
            {
                int index = 1;
                foreach (var item in Model.ProductItems)
                {
                    <tr>
                        <td>@(index++)</td>
                        <td>@item.ProductCat</td>
                        <td>@item.ProductName</td>
                        <td>
                            @(@item.ComboName == "No Combination Available" ? "--" : @item.ComboName)
                        </td>
                        <td class="text-end">@item.Price.ToString("C", culture)</td>
                        <td class="text-end">@item.Quantity.ToString("0")</td>
                        <td class="text-end">@item.Amount.ToString("C", culture)</td>
                        <td></td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="8" class="text-center text-muted">No items found.</td></tr>
            }
            @if (Model.ProductItems != null && Model.ProductItems.Any())
            {
                decimal totalPrice = Model.ProductItems.Sum(i => i.Price);
                decimal totalQty = Model.ProductItems.Sum(i => i.Quantity);
                decimal totalAmt = Model.ProductItems.Sum(i => i.Amount);

                <tr>
                    <td colspan="4" class="text-end fw-bold">Sub Total:</td>
                    <td class="text-end fw-bold">@totalPrice.ToString("C", culture)</td>
                    <td class="text-end fw-bold">@totalQty.ToString("0")</td>
                    <td class="text-end fw-bold"><span id="grandTotal">@totalAmt.ToString("C", culture)</span></td>
                    <td></td>
                </tr>
            }
        </tbody>
        <tbody id="@($"{idPrefix}_paymentTableBody")" class="table-light fw-bold">
            @* Payment Summary *@
            @{
                var paidAmount = Model.Order.TotPaidAmount;
                var totalAmount = Model.ProductItems.Sum(i => i.Amount);
                // var change = paidAmount - totalAmount;

                var payments = Model.Payments;
                var isCash = payments.All(p => p.PayMethod?.ToLower() == "cash");
            }

            @foreach (var payment in Model.Payments)
            {
                <tr class="table-light" data-payment="true">
                    <td colspan="4" class="text-end">Payment Method:</td>
                    <td colspan="2" class="text-end">@payment.PayMethod</td>
                    <td class="text-end">@payment.Amount.ToString("C", culture)</td>
                    <td class="text-muted small">@(!string.IsNullOrWhiteSpace(payment.ReferenceNo) ? $"Ref#: {payment.ReferenceNo}" : "")</td>
                </tr>
            }
            @{
                var totalServiceCharge = Model.Payments?.Sum(p => p.ServiceChargeAmount ?? 0) ?? 0;
                var serviceChargeRate = (Model.Payments?.Sum(p => p.ServiceChargePercent ?? 0) ?? 0) * 100;
                var grandTotal = totalAmount + totalServiceCharge;
                var change = paidAmount - grandTotal;
            }

            @if (totalServiceCharge > 0)            
            {
                <tr class="table-light fw-light">
                    <td colspan="6" class="text-end text-secondary">Credit Card Service Charge (@serviceChargeRate.ToString("N2")%):</td>
                    <td class="text-end text-secondary">@totalServiceCharge.ToString("C", culture)</td>
                    <td></td>
                </tr>
            }
            <tr class="table-light">
                <td colspan="6" class="text-end">Grand Total:</td>
                <td class="text-end text-black">@grandTotal.ToString("C", culture)</td>
                <td></td>
            </tr>
            <tr class="table-light">
                <td colspan="6" class="text-end">Total Payment:</td>
                <td class="text-end">@paidAmount.ToString("C", culture)</td>
                <td></td>
            </tr>
            <tr class="table-light fw-light">
                <td colspan="6" class="text-end">Change:</td>
                <td class="text-end">@change.ToString("C", culture)</td>
                <td></td>
            </tr>

        </tbody>
    </table>
</div>
