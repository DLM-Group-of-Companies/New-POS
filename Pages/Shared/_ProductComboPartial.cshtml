@using NLI_POS.Models
@model IList<ProductCombo>

<p>
    @* <a asp-page="Create">Create New</a> *@
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary btn-gradient bg-opacity-50 text-white" data-bs-toggle="modal" data-bs-target="#myListModal">
        <i class="fas fa-plus me-2"></i> Add Combination
    </button>
</p>
<table id="ComboTable" class="table">
    <thead>
        <tr>
            <th hidden>
                @Html.DisplayNameFor(model => model[0].Id)
            </th>
            <th>
                Combination
            </th>

            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td hidden>
                    @Html.DisplayFor(modelItem => item.Id)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.ProductsDesc)
                </td>

                <td>
                    @* <a asp-page="./Edit" class=" btn btn-success btn-sm  m-1" asp-route-id="@item.Id"><i class="far fa-edit"></i></a> *@
                    @* <a href="javascript:;" class="delete btn btn-danger btn-sm  m-1" title="Delete"><i class="fas fa-toggle-on"></i> </a> *@
                    <a href="javascript:;"
                       class="toggle-status btn @(item.IsActive ? "btn-success" : "btn-secondary") btn-sm m-1"
                       data-id="@item.Id"
                       data-productid="@item.ProductId"
                       data-status="@item.IsActive"
                       title="Toggle Active">
                        <i class="fas @(item.IsActive ? "fa-toggle-on" : "fa-toggle-off")"></i>
                    </a>
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
    $(function () {
        $("#ComboTable").on("click", ".toggle-status", function () {
            const button = $(this);
            const id = button.data("id");
            const isActive = button.data("status") === true || button.data("status") === "True";

            const newStatus = !isActive;
            const newLabel = newStatus ? 'Activate' : 'Deactivate';

            Swal.fire({
                title: `Are you sure you want to <b>${newLabel}</b> this combo?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: `Yes, ${newLabel}`,
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                preConfirm: () => {
                    return $.ajax({
                        type: 'POST',
                        url: '@Url.Page("/ProductCombos/Edit", "ToggleStatus")',
                        data: { id: id, isActive: newStatus },
                        headers: {
                            "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                        }
                    }).then(response => {
                        if (response.success) {
                            // Update button icon and data-status
                            button.find("i").removeClass("fa-toggle-on fa-toggle-off")
                                .addClass(newStatus ? "fa-toggle-on" : "fa-toggle-off");
                            button.data("status", newStatus);

                            const productId = button.data("productid");
                            Swal.fire('Success', `Record has been ${newStatus ? 'activated' : 'deactivated'}.`, 'success').then(() => {
                                $.get('@Url.Page("/ProductCombos/Edit", "RefreshCombos")', { productId: productId }, function (html) {
                                    $('#productComboContainer').html(html);
                                });
                            });



                        } else {
                            throw new Error(response.error || "Failed to update status.");
                        }
                    }).catch(error => {
                        Swal.fire('Error', error.message, 'error');
                    });
                }
            });
        });
    });
</script>


<script type="text/javascript">
    var vID;
    var selRow;
    var vName;

    $(function () {
        $("#ComboTable .delete").click(function () {
            const row = $(this).closest("tr");
            vID = row.find("td").eq(0).html().trim();
            vName = row.find("td").eq(1).html().trim(); // get the name
            selRow = row;

            Swal.fire({
                title: 'Are you sure?',
                html: `You are about to delete: <strong>${vName}</strong>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                preConfirm: () => {
                    return deleteRecord(); // calls the delete function
                }
            });
        });
    });

    function deleteRecord() {
        return $.ajax({
            type: 'POST',
            url: '@Url.Page("/ProductCombos/Delete")',
            cache: false,
            beforeSend: function () {
                showLoader();
            },
            data: {
                id: vID
            },
            headers: {
                "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (successDelete) {
                if (successDelete) {
                    selRow.remove();
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: `"${vName}" has been deleted.`,
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire('Failed', `Unable to delete "${vName}".`, 'error');
                }
            },
            error: function (xhr, status, error) {
                Swal.fire('Error', `An error occurred while deleting "${vName}".`, 'error');
                console.error(xhr.responseText);
            },
            complete: function () {
                hideLoader();
            }
        });
    }

    function gettoken() {
        var token = '@Html.AntiForgeryToken()';
        token = $(token).val();
        return token;
    }
</script>

