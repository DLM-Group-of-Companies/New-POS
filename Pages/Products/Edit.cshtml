@page
@model NLI_POS.Pages.Products.EditModel

@{
    ViewData["Title"] = "Edit Product";
}

<div class="container-fluid bg-white bg-gradient shadow p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-primary">
            <i class="far fa-edit me-2"></i>Edit Products
        </h4>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = './Index?pageNumber=@Model.PageNumber';"></i>
    </div>
    <hr />

    <form method="post" id="form" onsubmit="return validateAndShowLoader(this)">

        <div class="row p-2">
            <div class="col-md-12 p-2">
                @* First Column - New Product *@

                <div asp-validation-summary="ModelOnly" class="text-danger small"></div>
                <div class="row g-2">
                    <input asp-for="Products.Id" id="ProdMainID" type="hidden" />
                    <div class="col-md-4">
                        <div class="form-group">
                            <label asp-for="Products.ProductCode" class="control-label"></label>
                            <input asp-for="Products.ProductCode" class="form-control" />
                            <span asp-validation-for="Products.ProductCode" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="form-group">
                            <label asp-for="Products.ProductName" class="control-label"></label>
                            <input asp-for="Products.ProductName" class="form-control" />
                            <span asp-validation-for="Products.ProductName" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
                <div class="row g-2 mt-2 ">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label asp-for="Products.ProductClass" class="control-label"></label>
                            <select asp-for="Products.ProductClass" class="form-control">
                                <option value="">Select</option>
                                <option value="Main">Main</option>
                                <option value="Collateral">Collateral</option>
                            </select>
                            <span asp-validation-for="Products.ProductClass" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="form-group">
                            <label asp-for="Products.ProductDescription" class="control-label"></label>
                            <input asp-for="Products.ProductDescription" class="form-control" />
                            <span asp-validation-for="Products.ProductDescription" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
                <div class="row  g-2 mt-2 ">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="Products.ProductType" class="control-label"></label>
                            <select asp-for="Products.ProductType" class="form-control" asp-items="ViewBag.ProductType">
                                <option value="">Select</option>
                            </select>
                            <span asp-validation-for="Products.ProductType" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="Products.ProductCategory" class="control-label"></label>
                            @* <input asp-for="Products.ProductCategory" class="form-control" /> *@
                            <select asp-for="Products.ProductCategory" id="ProductCategory" class="form-control">
                                <option value="">Select</option>
                                <option value="Regular">Regular</option>
                                <option value="Package">Package</option>
                                <option value="Freebie">Freebie</option>
                            </select>
                            <span asp-validation-for="Products.ProductCategory" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Products.SKU" class="control-label"></label>
                            <input asp-for="Products.SKU" class="form-control" />
                            <span asp-validation-for="Products.SKU" class="text-danger small"></span>
                        </div>
                    </div>

                </div>
                <!-- PRODUCT PRICING -->
                <hr class="my-4" />

                <div class="row g-2">
                    <div class="col-md-8">
                        <h5 class="text-secondary"><i class="fas fa-tags me-2"></i>Product Price Details</h5>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-globe-asia fa-lg text-secondary" title="Country"></i>
                            <select asp-for="ProductPrice.CountryId" class="form-control form-select"
                                    asp-items="@(new SelectList(Model.Countries, "Id", "Name"))">
                                <option value="">Select Country</option>
                            </select>
                        </div>
                        <span asp-validation-for="ProductPrice.CountryId" class="text-danger small"></span>
                    </div>
                </div>

                <div class="row g-2 mt-2">
                    <div class="col-md-3">
                        <label asp-for="ProductPrice.UnitCost" class="form-label"></label>
                        <input asp-for="ProductPrice.UnitCost" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label asp-for="ProductPrice.RegPrice" class="form-label"></label>
                        <input asp-for="ProductPrice.RegPrice" class="form-control" />
                        <span asp-validation-for="ProductPrice.RegPrice" class="text-danger small"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="ProductPrice.DistPrice" class="form-label"></label>
                        <input asp-for="ProductPrice.DistPrice" class="form-control" />
                        <span asp-validation-for="ProductPrice.DistPrice" class="text-danger small"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="ProductPrice.StaffPrice" class="form-label"></label>
                        <input asp-for="ProductPrice.StaffPrice" class="form-control" />
                        <span asp-validation-for="ProductPrice.StaffPrice" class="text-danger small"></span>
                    </div>
                </div>

                <div class="row g-2 mt-2">
                    <div class="col-md-3">
                        <label asp-for="ProductPrice.BPPPrice" class="form-label"></label>
                        <input asp-for="ProductPrice.BPPPrice" class="form-control" />
                        <span asp-validation-for="ProductPrice.BPPPrice" class="text-danger small"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="ProductPrice.MedPackPrice" class="form-label"></label>
                        <input asp-for="ProductPrice.MedPackPrice" class="form-control" />
                        <span asp-validation-for="ProductPrice.MedPackPrice" class="text-danger small"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="ProductPrice.CorpAccPrice" class="form-label"></label>
                        <input asp-for="ProductPrice.CorpAccPrice" class="form-control" />
                        <span asp-validation-for="ProductPrice.CorpAccPrice" class="text-danger small"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="ProductPrice.NaturoPrice" class="form-label"></label>
                        <input asp-for="ProductPrice.NaturoPrice" class="form-control" />
                        <span asp-validation-for="ProductPrice.NaturoPrice" class="text-danger small"></span>
                    </div>
                </div>

                <hr />
                <!-- Active Switch & Hidden Fields -->
                <div class="row g-2 mt-2 align-items-center">
                    <div class="col-md-4">
                        <div class="form-group form-check form-switch">
                            <label class="form-check-label">
                                <input class="form-check-input" asp-for="Products.IsActive" /> Active
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group form-check form-switch">
                            <label class="form-check-label">
                                <input class="form-check-input" asp-for="Products.isFreebieAvailable" style="accent-color: green;" /> Freebie Available
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group form-check form-switch">
                            <label class="form-check-label">
                                <input class="form-check-input" asp-for="Products.isStaffAvailable" /> Staff Available
                            </label>
                        </div>
                    </div>
                </div>


                <input asp-for="Products.EncodeDate" type="hidden" />
                <input asp-for="Products.EncodedBy" type="hidden" />
                <input asp-for="Products.UpdateDate" type="hidden" />
                <input asp-for="Products.UpdatedBy" type="hidden" />

            </div>
            <div id="comboColumn" class="col-md-5 p-2 border border-info rounded" style="display:none">
                @*  2nd Column - Product Combination*@
                @* <partial name="_ProductComboPartial" model="Model.ProductCombos"></partial> *@
                <div id="productComboContainer">
                    @await Html.PartialAsync("_ProductComboPartial", Model.ProductCombos)
                </div>
            </div>

            <div class="form-group">
                <button type="submit" value="Save" class="btn btn-success"><i class="far fa-save me-2"></i>Save</button>
            </div>
        </div>

        @Html.AntiForgeryToken()
    </form>


    <!-- Modal -->
    <div class="modal fade" id="myListModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="myListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-primary" id="myListModalLabel"><i class="fas fa-cubes me-2"></i> Add Product Combination</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method='post' asp-page-handler='AddRow'>
                    <div class="modal-body">
                        <div class="row bg-secondary text-white">
                            <div class="col-8 col-md-8 p-2 border">Product</div>
                            <div class="col-2 col-md-2 p-2 border">Quantity</div>
                            <div class="col-2 col-md-2 p-2 border text-center"><i class="fas fa-grip-horizontal"></i></div>

                        </div>

                        <div id="newRow">
                            <input type="hidden" id="encodedList" value="0" />
                        </div>
                        <div class="p-2">
                            <button id="btnAdd" type="button" class="btn btn-info">Add Product <i class="fas fa-plus-circle"></i></button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="btnSaveCombo" class="btn btn-success"><i class="far fa-save me-2"></i>Save Changes</button> @* //onclick="saveListData()" *@
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        let myList = []; // Your list data in the modal
        let ProductComboList = [];
        let itemCount = 0;
        var combText = "";
        var newitem = "";

        function addProductComboRow() {
            let rowCount = parseInt($("#encodedList").val());
            itemCount++;
            rowCount++;
            let mainID = document.getElementById('ProdMainID').value;

            $("#encodedList").val(rowCount);

            $.ajax({
                type: "GET",
                url: "?handler=ProductList",
                success: function (data) {
                    let newselect = `<select id='ProductComboList[${rowCount}][1]'
                                                                                                     asp-for='ProductComboList[${rowCount}][1]'
                                                                                                     name='ProductComboList[${rowCount}][1]'
                                                                                                     class='form-control' required >`;

                    $.each(data, function (i, item) {
                        newselect += `<option value="${item.value}">${item.text}</option>`;
                    });

                    newselect += "</select>";

                    let newitem = `
                                                                                <div class="row p-1 inputRow">
                                                                                    <div class="col-8">
                                                                                        <div class="form-group">${newselect}</div>
                                                                                    </div>
                                                                                    <div class="col-2">
                                                                                        <input type="hidden" id="ProductComboList[${rowCount}][0]"
                                                                                               asp-for="ProductComboList[${rowCount}][0]"
                                                                                               name="ProductComboList[${rowCount}][0]"
                                                                                               value="${mainID}">
                                                                                        <input type="number" id="ProductComboList[${rowCount}][2]"
                                                                                               asp-for="ProductComboList[${rowCount}][2]"
                                                                                               name="ProductComboList[${rowCount}][2]"
                                                                                               class="form-control">
                                                                                    </div>
                                                                                            <div class="col-2 d-flex justify-content-center">
                                                                                                <button type="button" class="removeRow btn btn-danger btn-sm m-1" title="Remove">
                                                                                                    <i class="fas fa-minus-circle"></i>
                                                                                                </button>

                                                                                                <button id="addRow" type="button" onclick="getSelText(${rowCount});addProductComboRow()"
                                                                                                        class="btn btn-success btn-sm m-1" title="Save">
                                                                                                    <i class="fas fa-plus-circle"></i>
                                                                                                </button>
                                                                                                <input type="hidden" id="ProductComboList[${rowCount}][3]"
                                                                                               asp-for="ProductComboList[${rowCount}][3]"
                                                                                               name="ProductComboList[${rowCount}][3]">
                                                                                            </div>
                                                                                </div>`;

                    $("#newRow").append(newitem);
                },
                error: function (response) {
                    alert(response.responseText);
                }
            });
        }

        // Attach it on page load
        $(function () {
            $("#btnAdd").click(addProductComboRow);
        });

        $("#btnSaveCombo").click(function (e) {
            e.preventDefault();

            ProductComboList = []; // reset before collecting
            let isValid = true;

            $("#newRow .inputRow").each(function () {
                const select = $(this).find("select");
                const qtyInput = $(this).find("input[type='number']");
                const hiddenInputs = $(this).find("input[type='hidden']");

                const mainId = hiddenInputs.eq(0).val();         // [0] MainId
                const quantity = qtyInput.val();                 // [2] Quantity
                const productId = select.val();                  // [1] ProductId
                let combDesc = hiddenInputs.eq(1).val();         // [3] Description

                if (!productId || productId === "") {
                    toastr.warning('Please select a product.');
                    isValid = false;
                    return false; // IMPORTANT: stops the .each() loop
                }

                if (!quantity || quantity === "" || quantity  < 1) {
                    toastr.warning('Please specify quantity.');
                    isValid = false;
                    return false; // IMPORTANT: stops the .each() loop
                }

                if (!combDesc || combDesc.trim() === "") {
                    const selectedText = select.find("option:selected").text();
                    combDesc = `${quantity} ${selectedText}`;
                }


                ProductComboList.push([mainId, productId, quantity, combDesc]);
            });

            if (!isValid) {
                return; //so not to proceed below
            }

            showLoader();
            $.ajax({
                type: "POST",
                url: "?handler=AddRow",
                data: JSON.stringify(ProductComboList),
                contentType: "application/json; charset=utf-8",
                headers: {
                    'RequestVerificationToken': gettoken()
                },
                success: function (response) {
                    if (response) {
                        hideLoader();
                        toastr.success('Combination successfully added!');
                        $("#myListModal").modal('hide');
                        window.location.reload();
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    hideLoader();
                    console.log(errorThrown);
                    alert('error on save:' + textStatus);
                }
            });
        });


        $(document).on('click', '.removeRow', function () {
            var rowCount = parseInt($("#encodedList").val());
            rowCount--;
            $("#encodedList").val(rowCount);
            $(this).closest('.inputRow').remove();
        });

        // Show/Hide Combo Column
        $(document).ready(function () {

            var fieldValue = $('#ProductCategory').val();
            if (fieldValue == 'Package')
            //.....................^.......
            {
                $("#comboColumn").slideDown(500);
                $('.col-md-12').removeClass('col-md-12').addClass('col-md-7');
            }
            else {
                $("#comboColumn").hide();
                $('.col-md-7').removeClass('col-md-7').addClass('col-md-12');
            }

            $('#ProductCategory').on('change', function () {
                if (this.value == 'Package')
                //.....................^.......
                {
                    $("#comboColumn").slideDown(500);
                    $('.col-md-12').removeClass('col-md-12').addClass('col-md-7');
                }
                else {
                    $("#comboColumn").hide();
                    $('.col-md-7').removeClass('col-md-7').addClass('col-md-12');
                }
            });
        });

        function saveListData() {

            $('#myListModal').modal('hide');
            displayListInParent(myList);
        }

        function displayListInParent(list) {
            const myModelData = JsonSerializer.Serialize(Model);
            console.log(myModelData);

            displayDiv.innerHTML = '<strong>List Values:</strong><br>';
            if (list && list.length > 0) {
                list.forEach(item => {
                    displayDiv.innerHTML += `- ${item}<br>`;
                });
            } else {
                displayDiv.innerHTML += 'No list data.';
            }
        }

        async function sendData() {

            const response = await fetch("Edit?handler=SendData", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": gettoken()
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            console.log(result);
        }

        function gettoken() {
            var token = '@Html.AntiForgeryToken()';
            token = $(token).val();
            return token;
        }

        function getSelText(idx) {
            var Qty = document.getElementById("ProductComboList[" + idx + "][2]").value;
            var dropdownText = document.getElementById("ProductComboList[" + idx + "][1]");

            var selectedText = dropdownText.options[dropdownText.selectedIndex].text;

            combText = Qty + ' ' + selectedText;
            document.getElementById("ProductComboList[" + idx + "][3]").value = combText;

            const button1 = document.getElementById('addRow');
            if (button1) {
                button1.remove();
            }


            return combText;
        };
        //rowCount++;
        function populateMissingComboDescriptions() {
            $("#newRow .inputRow").each(function () {
                const qtyInput = $(this).find("input[type='number']");
                const select = $(this).find("select");
                const descInput = $(this).find("input[type='hidden']").eq(1);

                if (qtyInput.length && select.length && descInput.length) {
                    const qty = qtyInput.val();
                    const selectedText = select.find("option:selected").text();

                    if (!descInput.val()) {
                        descInput.val(qty + ' ' + selectedText);
                    }
                }
            });
        }

    </script>

    <script>
        // Retrieve prices based on country
        document.addEventListener("DOMContentLoaded", function () {
            const countrySelect = document.getElementById("ProductPrice_CountryId");
            let mainID = document.getElementById('ProdMainID').value;
            countrySelect.addEventListener("change", function () {
                showLoader();
                const countryId = this.value;
                if (countryId) {
                    fetch(`/Products/Edit?handler=Prices&countryId=${countryId}&id=${mainID}`)
                        .then(res => res.json())
                        .then(data => {
                            //console.log("Raw response:", text);
                            if (data) {
                                document.getElementById("ProductPrice_UnitCost").value = data.unitCost;
                                document.getElementById("ProductPrice_RegPrice").value = data.regPrice;
                                document.getElementById("ProductPrice_DistPrice").value = data.distPrice;
                                document.getElementById("ProductPrice_StaffPrice").value = data.staffPrice;
                                document.getElementById("ProductPrice_BPPPrice").value = data.bppPrice;
                                document.getElementById("ProductPrice_MedPackPrice").value = data.medPackPrice;
                                document.getElementById("ProductPrice_CorpAccPrice").value = data.corpAccPrice;
                                document.getElementById("ProductPrice_NaturoPrice").value = data.naturoPrice;
                                hideLoader();
                            } else {
                                clearPriceFields();
                            }
                        });

                } else {
                    clearPriceFields();
                }
            });

            function clearPriceFields() {
                const fields = [
                    "UnitCost", "RegPrice", "DistPrice", "StaffPrice",
                    "BPPPrice", "MedPackPrice", "CorpAccPrice", "NaturoPrice"
                ];

                fields.forEach(name => {
                    const el = document.getElementById("ProductPrice_" + name);
                    if (el) el.value = "";
                });
            }
        });
    </script>

}

