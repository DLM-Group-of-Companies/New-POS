@page
@model NLI_POS.Pages.Products.IndexModel

@{
    ViewData["Title"] = "Products";
}
<div class="container-fluid bg-white bg-gradient shadow p-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-primary">
            <i class="fas fa-box"></i> Products
        </h4>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = './Index';"></i>
    </div>
    <hr />
    <p>
        <a asp-page="Create" class="btn btn-primary"><i class="fas fa-plus-square fa-xl"></i>  Add New</a>
    </p>
 @*    <select id="countryFilter" class="form-select w-auto mb-2">
    <option value="">All Countries</option>
    @foreach (var country in Model.Countries)
    {
        <option value="@country.Id">@country.Name</option>
    }
</select> *@

    <table id="ProductTable" class="table table-striped table-sm">
        <thead>
            <tr>
                <th hidden></th>
                <th> 
                    @Html.DisplayNameFor(model => model.Product[0].ProductCode)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Product[0].ProductName)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Product[0].ProductType)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Product[0].ProductCategory)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Product[0].IsActive)
                </th>

                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Product)
            {
                var rowClass = item.IsActive ? "" : "opacity-50";
                <tr class="@rowClass">
                    <td hidden>@Html.DisplayFor(modelItem => item.Id)</td>
                    <td>
                        @Html.DisplayFor(modelItem => item.ProductCode)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.ProductName)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.ProductType)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.ProductCategory)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.IsActive)
                    </td>

                    <td>
                        <a asp-page="./Edit" asp-route-id="@item.Id">Edit</a> |
                        <a asp-page="./Details" asp-route-id="@item.Id">Details</a> 
                        @if (User.IsInRole("ADMIN"))
                        {
                            <span> | </span> <a class="details btn btn-outline-danger btn-sm rounded-circle m-1" title="Delete" href="javascript:;"><i class="fas fa-trash-alt"></i> </a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

 @*    <table id="productsTable" class="display nowrap w-100">
    <thead>
        <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Type</th>
            <th>Category</th>
            <th>Class</th>
            <th>Available</th>
        </tr>
    </thead>
</table> *@
</div>

<script>
//     $(document).ready(function () {
//     var table = $('#productsTable').DataTable({
//         dom: 'Bfrtip',
//         buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
//         ajax: {
//             url: '@Url.Page("Index", "Products")',
//             data: function (d) {
//                 d.countryId = $('#countryFilter').val();
//             },
//             dataSrc: 'data'
//         },
//         columns: [
//             { data: 'code' },
//             { data: 'name' },
//             { data: 'type' },
//             { data: 'category' },
//             { data: 'productClass', visible: false },
//         {
//             data: 'active',
//             render: function (data, type, row) {
//                 if (type === 'display') {
//                     return data
//                         ? '<i class="fas fa-check text-success"></i>'  // ✅ check icon
//                         : '<i class="fas fa-times text-danger"></i>';  // ❌ cross icon
//                 }
//                 return data;
//             },
//             className: 'text-center'
//         }
//         ],
//         responsive: true,
//             serverSide: false, // or true if doing server-side paging
//     order: [[4, 'desc']], // 👈 index of your ProductClass column, 0-based
//     });

//     $('#countryFilter').change(function () {
//         table.ajax.reload();
//     });
// });


    $(document).ready(function () {
        $('#ProductTable').DataTable({
            dom: 'Bfrtip',
            responsive: true,
            buttons: [
                {
                    extend: 'copy',
                    className: 'btn btn-sm btn-outline-secondary',
                    exportOptions: { columns: ':not(:last-child)' }
                },
                {
                    extend: 'csv',
                    className: 'btn btn-sm btn-outline-success',
                    exportOptions: { columns: ':not(:last-child)' }
                },
                {
                    extend: 'excel',
                    className: 'btn btn-sm btn-outline-success',
                    exportOptions: { columns: ':not(:last-child)' }
                },
                {
                    extend: 'pdfHtml5',
                    orientation: 'landscape',
                    className: 'btn btn-sm btn-outline-danger',
                    exportOptions: { columns: ':not(:last-child)' }
                },
                {
                    extend: 'print',
                    className: 'btn btn-sm btn-outline-dark',
                    exportOptions: { columns: ':not(:last-child)' }
                }
            ],
            columnDefs: [
                { targets: [0], visible: false }, // Hide ID column
                { targets: -1, orderable: false } // Disable sort on last column (Actions)
            ]
        });
    });

</script>


<script type="text/javascript">
    var vID;
    var selRow;
    $(function () {
        $("#ProductTable .details").click(function () {
            vID = $(this).closest("tr").find("td").eq(0).html();
            selRow = $(this).closest("tr");
            // alert(vID.trim())
            $.ajax({
                cache: false,
                type: "GET",
                url: '@Url.Page("Delete")',
                data: { __RequestVerificationToken: gettoken(), id: vID.trim() },
                // contentType: "application/json; charset=utf-8",
                // dataType: "html",
                success: function (response) {
                    // alert('response:' + response);
                    $("#partialModal").find(".modal-title").html('<i class="fas fa-question-circle fa-lg"></i> Confirmation');
                    $("#partialModal").find(".modal-footer-button").html('<button type="button" class="btn btn-danger" onclick="deleteRecord()"><i class="fas fa-user-times"></i> Delete</button>');

                    $("#partialModal").find(".modal-body").html(response);
                    $("#partialModal").modal('show');
                },
                failure: function (response) {
                    alert('failure:' + response.responseText);
                },
                error: function (response) {
                    $("#partialModal").find(".modal-body").html(response);
                    // alert('error:' + response.responseText);
                    alert('Error encountered. This record may already have been deleted.');
                }
            });
        });
    });

    function deleteRecord() {
        // var vPatID = $(this).closest("tr").find("td").eq(0).html();
        alert(vID);

        // Send AJAX request to check if the record exists
        $.ajax({
            // url: '/Patients/Create/PatientExists', // Adjust the URL to match your route
            url: '@Url.Page("Delete")',
            type: 'POST',
            cache: false,
            data: { __RequestVerificationToken: gettoken(), id: vID.trim() },
            success: function (successDelete) {
                if (successDelete) {
                    toastr.options.closeButton = false;
                    toastr.options.timeOut = 800;
                    toastr.options.fadeOut = 1000;
                    toastr.options.onHidden = function () { selRow.remove(); }
                    toastr.success('Successfully deleted!');
                    $("#partialModal").modal('hide');
                }
            },
            error: function (xhr, status, error) {
                //toastr.waring('@TempData["Message"]');
                alert('An error occurred while deleting the record.');
                alert('err:' + xhr.responseText);
            }
        });
    }

    function gettoken() {
        var token = '@Html.AntiForgeryToken()';
        token = $(token).val();
        return token;
    }

</script>
<script>
    $('body').on('hidden.bs.modal', '.modal', function () {
        $(this).removeData('bs.modal');
        // alert('closed');
    });
</script>

<script>
    //For paging display fix
    $(document).ready(function () {
        $('ul.pagination > li.disabled > a').addClass('page-link');
    });
</script>

<script type="text/javascript">

    $(function () {
        $("#pageSize").change(function () {
            //alert($("#pageSize").val());
            $("#form1").submit();
        });
    });
</script>