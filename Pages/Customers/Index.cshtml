@page
@using NLI_POS.Services
@model NLI_POS.Pages.Customers.IndexModel

@{
    ViewData["Title"] = "Customers";
}
<div class="container-fluid bg-white bg-gradient  shadow p-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-primary">
            <i class="fas fa-users"></i> Customers
        </h4>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = '../Index';"></i>
    </div>
    <hr />
    <p>
        <a class="btn btn-primary btn-gradient" asp-page="Create"><i class="fas fa-user-plus"></i> Add Customer</a>
    </p>
    <div class="table-scroll-container">
        <table id="customerTable" class="table table-striped table-sm">
        <thead class="table-primary">
            <tr>
                <th>
                    @Html.DisplayNameFor(model => model.Customer[0].CustCode)
                </th>

                <th>
                    @Html.DisplayNameFor(model => model.Customer[0].FirstName)
                </th>

                <th>
                    @Html.DisplayNameFor(model => model.Customer[0].LastName)
                </th>

                <th>
                    Contact Number(s)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Customer[0].Email)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Customer[0].City)
                </th>

@* 
                <th>
                    @Html.DisplayNameFor(model => model.Customer[0].OfficeCountry)
                </th> *@
                <th>
                    @Html.DisplayNameFor(model => model.Customer[0].CustClasses)
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Customer)
            {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.CustCode)
                    </td>

                    <td>
                        @Html.DisplayFor(modelItem => item.FirstName)
                    </td>

                    <td>
                        @Html.DisplayFor(modelItem => item.LastName)
                    </td>

                    <td>
                        @Html.DisplayFor(modelItem => item.MobileNo)
                        @if (!string.IsNullOrWhiteSpace(item.LandlineNo))
                        {
                            <span> | @Html.DisplayFor(modelItem => item.LandlineNo)</span>
                        }

                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Email)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.City)
                    </td>

@*                     <td>
                        @Html.DisplayFor(modelItem => item.OfficeCountry.Name)
                    </td> *@
                    <td>
                        @Html.DisplayFor(modelItem => item.CustClasses.Name)
                    </td>
                    <td class="text-nowrap">
                        
                            <a asp-page="./Edit" asp-route-id="@item.Id" class="btn btn-success btn-sm" title="Edit"><i class="fas fa-user-edit"></i></a>
                            <a asp-page="./Details" asp-route-id="@item.Id" class="btn btn-primary btn-sm " title="Details"><i class="fas fa-user-tag"></i></a>
                            @* <a asp-page="./Delete" asp-route-id="@item.Id" class="btn btn-danger btn-sm" title="Delete"><i class="fas fa-user-times"></i></a> *@
                            <button type="button"
                                    class="btn btn-danger btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteCustomerModal"
                                    data-id="@item.Id"
                                    data-name="@($"{@item.CustCode}: {item.FirstName} {item.LastName}")"
                                    title="Delete">
                                <i class="fas fa-user-times"></i>
                            </button>

                       
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCustomerModal" tabindex="-1" aria-labelledby="deleteCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCustomerModalLabel"><i class="fas fa-user-times me-2"></i>Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="Delete">
                <div class="modal-body">

                    <div class="text-center">
                        <i class="fa-regular fa-circle-question fa-7x text-danger mb-5"></i>

                        <input type="hidden" name="id" id="deleteCustomerId" />
                        <p class="text-center">
                            Are you sure you want to delete <br />
                            <h4 class="text-center" id="deleteCustomerName">?</h4>
                        </p>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i> Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@{
    var canDelete = User.HasPermission("Delete");
}

<script>
    document.getElementById("preloader").style.display = "flex";

    $(document).ready(function () {
        $('#customerTable').DataTable({
            responsive: true,
            dom: 'Bfrtip',
            responsive: true,
            buttons: [
                {
                    extend: 'copy',
                    className: 'btn btn-sm btn-outline-secondary',
                    exportOptions: { columns: ':not(:last-child)' }
                },
                {
                    extend: 'csv',
                    className: 'btn btn-sm btn-outline-success',
                    exportOptions: { columns: ':not(:last-child)' }
                },
                {
                    extend: 'excel',
                    className: 'btn btn-sm btn-outline-success',
                    exportOptions: { columns: ':not(:last-child)' }
                },
                {
                    extend: 'pdfHtml5',
                    orientation: 'landscape',
                    className: 'btn btn-sm btn-outline-danger',
                    exportOptions: { columns: ':not(:last-child)' }
                },
                {
                    extend: 'print',
                    className: 'btn btn-sm btn-outline-dark',
                    exportOptions: { columns: ':not(:last-child)' }
                }

            ],
            columnDefs: [
                { responsivePriority: 1, targets: 0 },  // CustCode (important)
                { responsivePriority: 2, targets: 1 },  // FirstName
                { responsivePriority: 3, targets: 2 },  // LastName
                { responsivePriority: 4, targets: 3 },  // Contact Numbers
                { responsivePriority: 5, targets: 4 },  // Province
                { responsivePriority: 6, targets: 5 },  // City
                // { responsivePriority: 7, targets: 6 },  // OfficeCountry
                { responsivePriority: 7, targets: 7 },  // CustClasses
                { responsivePriority: 10001, targets: 7 } // Edit/Delete links - lowest priority
            ],
            initComplete: function () {
                // Hide the loader when DataTable finishes initializing
                document.getElementById("preloader").style.display = "none";
            }
        });
    });

    // Show loader on AJAX request
    $('#customerTable').on('preXhr.dt', function () {
        $('#preloader').show();
    });

    // Hide loader when data is loaded
    $('#customerTable').on('xhr.dt', function () {
        $('#preloader').hide();
    });

</script>

<script>
    const userCanDelete = @User.HasPermission("Delete").ToString().ToLower(); // outputs true or false

    // Listen to modal's "show" event
    const deleteModal = document.getElementById('deleteCustomerModal');

    deleteModal.addEventListener('show.bs.modal', function (event) {
        if (!userCanDelete) {
            event.preventDefault(); // 🔴 Stop the modal from opening
            toastr.error("You are not authorized to delete.");
            return;
        }

        const button = event.relatedTarget;
        const customerId = button.getAttribute('data-id');
        const customerName = button.getAttribute('data-name');

        document.getElementById('deleteCustomerId').value = customerId;
        document.getElementById('deleteCustomerName').textContent = customerName;
    });
</script>
