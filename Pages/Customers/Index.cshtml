@page
@using NLI_POS.Services
@model NLI_POS.Pages.Customers.IndexModel

@{
    ViewData["Title"] = "Customers";
}
<div class="container-fluid bg-white bg-gradient shadow p-2 pb-1">
    <div class="d-flex justify-content-between align-items-center mb-1">
        <h4 class="m-2 mb-0 text-primary">
            <i class="fas fa-users"></i> Customers
        </h4>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = '../Index';"></i>
    </div>
    <hr />
    <div class="container">

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2" id="customFilterRow">
            <a class="btn btn-primary btn-gradient" asp-page="Create"><i class="fas fa-user-plus me-2"></i> New Customer</a>
            <div id="exportButtons"></div>

            <div class="d-flex flex-column flex-md-row align-items-center gap-2" id="rightControls">
                <select id="countrySelect" class="form-select" title="Filter by Country">
                    <option value="">All Countries</option>
                    @foreach (var country in (IEnumerable<SelectListItem>)ViewBag.Countries)
                    {
                        <option value="@country.Value">@country.Text</option>
                    }
                </select>

                <div id="searchBoxContainer" title="Search by name, email, mobile, city..."></div>
            </div>
        </div>


        <table id="customerTable" class="table table-striped table-sm align-middle">
            <thead class="table-primary">
                <tr>
                    <th>Cust Code</th>
                    <th>Full Name</th>
                    <th>Contact No.</th>
                    <th>Email</th>
                    <th>City</th>
                    <th>Class</th>
                    <th>Id</th>
                    <th class="actions-column text-center">Actions</th>
                </tr>
            </thead>
        </table>
        @Html.AntiForgeryToken()
    </div>
</div>
@{
    var canDelete = User.HasPermission("Delete");
}

@section Scripts {
    <script>
        const referrer = document.referrer;

        if (referrer.includes("/Index") || referrer.endsWith("/")) {
            sessionStorage.removeItem('CustomerTableState');
        }

        const userCanDelete = @(User.HasPermission("Delete").ToString().ToLower() == "true" ? "true" : "false");

        $(document).ready(function () {
            const table = $('#customerTable').DataTable({
                dom: 'Bfrtip', // Manually move the buttons and search box // 'B' for Buttons, 'f' for searching, 'r' for processing display, 't' for table, 'i' for information, 'p' for pagination
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fas fa-file-excel me-2"></i>  Export to Excel ', // Custom button text
                        title: 'Customers', // Title for the Excel file
                        exportOptions: {
                            columns: ':visible' // Only export visible columns
                        }
                    }],
                stateSave: true,
                stateSaveCallback: function (settings, data) {
                    sessionStorage.setItem('CustomerTableState', JSON.stringify(data));
                },
                stateLoadCallback: function (settings) {
                    return JSON.parse(sessionStorage.getItem('CustomerTableState'));
                },
                processing: true,
                serverSide: true,
                ajax: {
                    url: '@Url.Page("Index", "Data")',
                    type: 'GET',
                    data: function (d) {
                        d.country = $('#countrySelect').val();
                    }
                },
                responsive: true,
                columns: [
                    { data: 'custCode' },
                    { data: 'fullName' },
                    { data: 'mobile' },
                    { data: 'email' },
                    { data: 'city' },
                    { data: 'className' },
                    { data: 'id', visible: false },
                    {
                        data: 'id',
                        className: 'text-end',
                        render: function (data, type, row) {
                            let name = `${row.custCode}: ${row.fullName}`;
                            return `
                                                           <a href="/Customers/Edit?id=${data}" class="btn btn-success btn-sm btn-icon" title="Edit"><i class="fas fa-user-edit"></i></a>
                                                           <a href="/Customers/Details?id=${data}" class="btn btn-primary btn-sm btn-icon" title="Details"><i class="fas fa-user-tag"></i></a>
                                                                   <button type="button" class="delete-btn btn btn-danger btn-sm btn-icon" data-id="${data}" data-name="${name}" title="Delete">
                                                                <i class="fas fa-user-times"></i>
                                                            </button>
                                                        `;
                        },

                        orderable: true,
                        searchable: false
                    }
                ],
                order: [[6, 'desc']],
                initComplete: function () {
                    // Style and place export buttons
                    const $buttons = table.buttons().container().addClass('d-inline-block');
                    $buttons.find('button')
                        .removeClass('dt-button')
                        .addClass('btn btn-outline-success btn-gradient me-2');
                    $('#exportButtons').append($buttons);

                    // Move and style search input
                    const $searchInput = $('#customerTable_filter input')
                        .addClass('form-control')
                        .attr('placeholder', '🔍 Search...')
                        .css('min-width', '250px');

                    // Remove label text from default search wrapper
                    $('#customerTable_filter label').contents().filter(function () {
                        return this.nodeType === 3;
                    }).remove();

                    // Move Country dropdown next to search
                    const $countrySelect = $('#countrySelect')
                        .addClass('form-select')
                        .css('min-width', '180px');

                    // Wrap both in a flexbox container
                    const $searchGroup = $('<div class="d-flex flex-column flex-md-row align-items-center gap-2 w-100 justify-content-end"></div>')
                        .append($countrySelect)
                        .append($searchInput);


                    $('#searchBoxContainer').append($searchGroup);
                }

            });
        });

        //Reload on Country change
        $('#countrySelect').on('change', function () {
            $('#customerTable').DataTable().ajax.reload();
        });

    </script>


    <script>
        $(document).on('click', '.delete-btn', function () {
            const customerId = $(this).data('id');
            const customerName = $(this).data('name');

            Swal.fire({
                title: 'Are you sure?',
                text: `Delete customer: ${customerName}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ⛑ Get anti-forgery token
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    fetch(`/Customers?handler=Delete&id=${customerId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({})
                    })
                        .then(async response => {
                            const data = await response.json(); // parse JSON even for error
                            if (response.ok) {
                                Swal.fire('Deleted!', data.message, 'success');
                                $('#customerTable').DataTable().ajax.reload(null, false);
                            } else {
                                Swal.fire('Failed', data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error(error);
                            Swal.fire('Error', 'Unexpected error occurred', 'error');
                        });

                }
            });
        });
    </script>

}