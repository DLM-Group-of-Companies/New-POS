@page
@using NLI_POS.Services
@model NLI_POS.Pages.Customers.IndexModel

@{
    ViewData["Title"] = "Customers";
}
<div class="container-fluid bg-white bg-gradient shadow p-4 pb-1">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-primary">
            <i class="fas fa-users"></i> Customers
        </h4>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = '../Index';"></i>
    </div>
    <hr />
    <p>
        <a class="btn btn-primary btn-gradient" asp-page="Create"><i class="fas fa-user-plus"></i> Add Customer</a>
    </p>

    <table id="customerTable" class="table table-striped table-sm">
        <thead class="table-primary">
            <tr>
                <th>Cust Code</th>
                <th>Full Name</th>
                <th>Contact No.</th>
                <th>Email</th>
                <th>City</th>
                <th>Class</th>
                <th class="actions-column text-center">Actions</th>
            </tr>
        </thead>
    </table>
    @Html.AntiForgeryToken()
</div>

<!-- Delete Confirmation Modal -->
@* <div class="modal fade" id="deleteCustomerModal" tabindex="-1" aria-labelledby="deleteCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCustomerModalLabel"><i class="fas fa-user-times me-2"></i>Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="Delete">
                <div class="modal-body">

                    <div class="text-center">
                        <i class="fa-regular fa-circle-question fa-7x text-danger mb-5"></i>

                        <input type="hidden" name="id" id="deleteCustomerId" />
                        <p class="text-center">
                            Are you sure you want to delete <br />
                            <h4 class="text-center" id="deleteCustomerName">?</h4>
                        </p>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i> Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</div> *@

@{
    var canDelete = User.HasPermission("Delete");
}

@section Scripts {
    <script>
        const referrer = document.referrer;

        if (referrer.includes("/Index") || referrer.endsWith("/")) {
            sessionStorage.removeItem('CustomerTableState');
        }

        const userCanDelete = @(User.HasPermission("Delete").ToString().ToLower() == "true" ? "true" : "false");

        $(document).ready(function () {
            const table = $('#customerTable').DataTable({
                stateSave: true,
                stateSaveCallback: function (settings, data) {
                    sessionStorage.setItem('CustomerTableState', JSON.stringify(data));
                },
                stateLoadCallback: function (settings) {
                    return JSON.parse(sessionStorage.getItem('CustomerTableState'));
                },
                processing: true,
                serverSide: true,
                ajax: {
                    url: '@Url.Page("Index", "Data")',
                    type: 'GET'
                },
                columns: [
                    { data: 'custCode' },
                    { data: 'fullName' },
                    { data: 'mobile' },
                    { data: 'email' },
                    { data: 'city' },
                    { data: 'className' },
                    {
                        data: 'id',
                        render: function (data, type, row) {
                            let name = `${row.custCode}: ${row.fullName}`;
                            return `
                                           <a href="/Customers/Edit?id=${data}" class="btn btn-success btn-sm btn-icon" title="Edit"><i class="fas fa-user-edit"></i></a>
                                           <a href="/Customers/Details?id=${data}" class="btn btn-primary btn-sm btn-icon" title="Details"><i class="fas fa-user-tag"></i></a>
                                                   <button type="button" class="delete-btn btn btn-danger btn-sm btn-icon" data-id="${data}" data-name="${name}" title="Delete">
                                                <i class="fas fa-user-times"></i>
                                            </button>
                                        `;
                        },
                        orderable: false,
                        searchable: false
                    }
                ]
            });

        });
    </script>

@*     <script>
        const userCanDelete = @(User.HasPermission("Delete").ToString().ToLower() == "true" ? "true" : "false");
        // Listen to modal's "show" event
        const deleteModal = document.getElementById('deleteCustomerModal');

        deleteModal.addEventListener('show.bs.modal', function (event) {
            if (!userCanDelete) {
                event.preventDefault(); // 🔴 Stop the modal from opening
                toastr.error("You are not authorized to delete.");
                return;
            }

            const button = event.relatedTarget;
            const customerId = button.getAttribute('data-id');
            const customerName = button.getAttribute('data-name');

            document.getElementById('deleteCustomerId').value = customerId;
            document.getElementById('deleteCustomerName').textContent = customerName;
        });
    </script> *@

    <script>
        $(document).on('click', '.delete-btn', function () {
            const customerId = $(this).data('id');
            const customerName = $(this).data('name');

            Swal.fire({
                title: 'Are you sure?',
                text: `Delete customer: ${customerName}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ⛑ Get anti-forgery token
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    fetch(`/Customers?handler=Delete&id=${customerId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({})
                    })
                        .then(async response => {
                            const data = await response.json(); // parse JSON even for error
                            if (response.ok) {
                                Swal.fire('Deleted!', data.message, 'success');
                                $('#customerTable').DataTable().ajax.reload();
                            } else {
                                Swal.fire('Failed', data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error(error);
                            Swal.fire('Error', 'Unexpected error occurred', 'error');
                        });

                }
            });
        });
    </script>

}