@page
@model NLI_POS.Pages.Report.DashboardModel
@{
    ViewData["Title"] = "Sales Dashboard";
}
<div class="container-fluid bg-dark bg-gradient  shadow p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-light mb-0">
            <i class="fas fa-tachometer-alt me-2"></i> Dashboard
        </h3>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = '../Index';"></i>
    </div>
    <hr class="text-light" />
    <div class="row mb-4" id="topKpis">
        <div class="col-md-4">
            <div class="card text-white bg-success bg-gradient shadow">
                <div class="card-body">
                    <h5>Total Sales Today</h5>
                    <h3 id="totalSalesToday">₱0.00</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-primary bg-gradient shadow">
                <div class="card-body">
                    <h5>Orders Today</h5>
                    <h3 id="orderCountToday">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning bg-gradient shadow">
                <div class="card-body">
                    <h5>Average Order Value</h5>
                    <h3 id="avgOrderValueToday">₱0.00</h3>
                </div>
            </div>
        </div>
    </div>

    <hr class="text-light" />

    <form id="filtersForm" class="row mb-4">
        <div class="col-md-3">
            <label for="officeSelect" class="form-label text-light">Office</label>
            <select id="officeSelect" name="officeId" class="form-select form-select-sm">
                <option value="">All Offices</option>
                @foreach (var office in Model.OfficeList)
                {
                    <option value="@office.Id">@office.Name</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label for="startDate" class="form-label text-light">Start Date</label>
            <input type="date" id="startDate" name="startDate" class="form-control form-control-sm" />
        </div>

        <div class="col-md-3">
            <label for="endDate" class="form-label text-light">End Date</label>
            <input type="date" id="endDate" name="endDate" class="form-control form-control-sm" />
        </div>

        <div class="col-md-3 align-self-end">
            <button type="button" id="generateReportBtn" class="btn btn-sm btn-primary w-100">Apply Filters</button>
        </div>
    </form>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm p-3">
                <h2 class="h5 mb-3">Sales Per Main Products</h2>
                <canvas id="salesPerProductChart" height="100"></canvas>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm p-3">
                <h2 class="h5 mb-3">Top Sales People</h2>
                <canvas id="topSalespeopleChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm p-3">
                <h2 class="h5 mb-3">Top Customers</h2>
                <canvas id="topCustomersChart" height="425"></canvas>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow-sm p-3">
                <h2 class="h5 mb-3">Repeat Customers</h2>
                <div class="small">
                    <table id="repeatCustomersTable" class="table table-striped table-sm ">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Orders</th>
                                <th>Last Order</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


</div>
@section Scripts {
    <script>
        async function loadTopKpis() {
            try {
                const response = await fetch('/Report/Dashboard?handler=TopKpis');
                const data = await response.json();

                document.getElementById('totalSalesToday').textContent = `₱${data.totalSales.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
                document.getElementById('orderCountToday').textContent = data.orderCount;
                document.getElementById('avgOrderValueToday').textContent = `₱${data.averageOrderValue.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
            } catch (err) {
                console.error('Failed to load KPIs:', err);
            }
        }

        document.addEventListener('DOMContentLoaded', loadTopKpis);
    </script>
    <script>
        async function loadTopCustomersChart() {
            const response = await fetch('?handler=TopCustomers');
            const data = await response.json();

            const labels = data.map(x => x.customerName);
            const values = data.map(x => x.totalSpent);

            const ctx = document.getElementById('topCustomersChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Spent',
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        barPercentage: 0.7,   // 🔹 Make bars take up 70% of category space
                        categoryPercentage: 0.8 // 🔹 Adjust space between groups
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => `₱${ctx.raw.toLocaleString()}` } }
                    }
                }
            });
        }
    </script>
    <script>
        async function loadRepeatCustomersTable() {
            const response = await fetch('?handler=RepeatCustomers');
            const data = await response.json();

            const tbody = document.querySelector('#repeatCustomersTable tbody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                                                                <td>${row.customerName}</td>
                                                                <td>${row.orderCount}</td>
                                                                <td>${new Date(row.lastOrder).toLocaleDateString()}</td>
                                                            `;
                tbody.appendChild(tr);
            });

            // Initialize DataTable
            if ($.fn.DataTable.isDataTable('#repeatCustomersTable')) {
                $('#repeatCustomersTable').DataTable().destroy();
            }

            $('#repeatCustomersTable').DataTable({
                order: [[1, 'desc']],
                pageLength: 10,
                lengthChange: false,
                searching: false,
                info: false
            });
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadTopCustomersChart();
            loadRepeatCustomersTable();
            loadSalesChart();
        });

        // If using filters (startDate, endDate), pass them as query params in your fetch calls
    </script>

    <script>
        let chart;

        async function loadSalesChart() {
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            const officeId = document.getElementById("officeSelect").value;

            const params = new URLSearchParams();
            if (startDate) params.append("startDate", startDate);
            if (endDate) params.append("endDate", endDate);
            if (officeId) params.append("officeId", officeId);

            const response = await fetch('?handler=SalesChart&' + params.toString());
            const data = await response.json();

            const labels = data.map(x => x.productName);
            const sales = data.map(x => x.totalSales);

            // 🎨 Custom or random color assignment
            const backgroundColors = labels.map(name => getProductColor(name));

            const ctx = document.getElementById('salesPerProductChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sales',
                        data: sales,
                        backgroundColor: backgroundColors,
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        // 🎯 Fixed colors for known products
        function getProductColor(name) {
            switch (name.toLowerCase()) {
                case 'cryptomonadales': return 'rgba(0, 128, 0, 0.7)';       // Green
                case 'cleanse': return 'rgba(255, 165, 0, 0.7)';             // Yellow Orange
                case 'ppars plus': return 'rgba(128, 0, 128, 0.7)';          // Purple
                case 'coffee': return 'rgba(139, 69, 19, 0.7)';              // Brown
                default: return getRandomColor();                            // Fallback to random
            }
        }

        // 🎨 Helper to generate a random pastel-like color
        function getRandomColor() {
            const r = Math.floor(Math.random() * 155) + 100;
            const g = Math.floor(Math.random() * 155) + 100;
            const b = Math.floor(Math.random() * 155) + 100;
            return `rgba(${r}, ${g}, ${b}, 0.7)`;
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("generateReportBtn").addEventListener("click", loadSalesChart);
        });
    </script>

    <script>
        async function loadTopSalespeopleChart() {
            const response = await fetch('?handler=TopSalespeople');
            const data = await response.json();

            const labels = data.map(x => x.salesperson);
            const values = data.map(x => x.totalSales);

            const ctx = document.getElementById('topSalespeopleChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sales',
                        data: values,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1,
                        barThickness: 25 // <-- makes bars thicker
                    }]
                },
                options: {
                    indexAxis: 'y', // horizontal bar chart
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `₱${ctx.raw.toLocaleString()}`
                            }
                        }
                    }
                }
            });
        }

        // Load on page start
        loadTopSalespeopleChart();
    </script>
}