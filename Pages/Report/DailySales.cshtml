@page
@model NLI_POS.Pages.Report.DailySalesModel

@{
    ViewData["Title"] = "Daily Sales";
}
<div class="container-fluid bg-white bg-gradient rounded-3 shadow p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary mb-0">
            <i class="fas fa-calendar-day me-2"></i> Daily Sales Report
        </h3>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = '../Index';"></i>
    </div>
    <hr />
    <div class="row g-3 mb-4">
        <form method="get" class="row g-3 mb-4">
            <div class="col-md-2">
                <label for="officeFilter" class="form-label">Office</label>
                <select asp-for="Office" asp-items="Model.OfficeList" class="form-select"></select>
            </div>
            <div class="col-md-2">
                <label for="dDate" class="form-label">Date</label>
                <input type="date" id="dDate" name="Date" value="@(Model.Date?.ToString("yyyy-MM-dd"))" class="form-control" />
            </div>
            <div class="col-md-2 align-self-end">
                <button type="submit" class="btn btn-primary"><i class="fas fa-filter me-2"></i> Filter</button>
            </div>
        </form>

    </div>

    <div class="table-responsive">
        <table id="ordersTable" class="table table-bordered table-hover table-sm small w-100 text-nowrap">
            <thead class="table-light text-center">
                <tr>
                    <th>@Html.DisplayNameFor(m => m.Order[0].OrderNo)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].OrderDate)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].Customers.CustCode)</th>
                    <th>Customer</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].ItemNo)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].OrderType)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].ProductCategory)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].Products)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].ProductCombos)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].Office)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].Price)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].Qty)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].Amount)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].PaymentMethod)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].RefNo)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].Notes)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].EncodeDate)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].EncodedBy)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].UpdateDate)</th>
                    <th>@Html.DisplayNameFor(m => m.Order[0].UpdatedBy)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Order)
                {
                    <tr>
                        <td>@Html.DisplayFor(m => item.OrderNo)</td>
                        <td>@Html.DisplayFor(m => item.OrderDate)</td>
                        <td>@Html.DisplayFor(m => item.Customers.CustCode)</td>
                        <td>@Html.DisplayFor(m => item.Customers.FirstName) @Html.DisplayFor(m => item.Customers.LastName)</td>
                        <td>@Html.DisplayFor(m => item.ItemNo)</td>
                        <td>@Html.DisplayFor(m => item.OrderType)</td>
                        <td>@Html.DisplayFor(m => item.ProductCategory)</td>
                        <td>@Html.DisplayFor(m => item.Products.ProductName)</td>
                        <td>@Html.DisplayFor(m => item.ProductCombos.ProductsDesc)</td>
                        <td>@Html.DisplayFor(m => item.Office.Name)</td>
                        <td>@Html.DisplayFor(m => item.Price)</td>
                        <td>@Html.DisplayFor(m => item.Qty)</td>
                        <td>@Html.DisplayFor(m => item.Amount)</td>
                        <td>@Html.DisplayFor(m => item.PaymentMethod)</td>
                        <td>@Html.DisplayFor(m => item.RefNo)</td>
                        <td>@Html.DisplayFor(m => item.Notes)</td>
                        <td>@Html.DisplayFor(m => item.EncodeDate)</td>
                        <td>@Html.DisplayFor(m => item.EncodedBy)</td>
                        <td>@Html.DisplayFor(m => item.UpdateDate)</td>
                        <td>@Html.DisplayFor(m => item.UpdatedBy)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const table = $('#ordersTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        className: 'btn btn-outline-success',
                        exportOptions: {
                            columns: ':visible'
                        },
                        filename: function () {
                            const office = $('select[name="Office"]').val() || 'AllOffices';
                            const date = $('#dDate').val() || new Date().toISOString().slice(0, 10);
                            return `DailySales_${office}_${date}`;
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        className: 'btn btn-outline-danger',
                        exportOptions: { columns: [0, 1, 2, 4, 5, 6, 7, 8] }
                    },
                    {
                        extend: 'print',
                        className: 'btn btn-outline-secondary',
                        exportOptions: { columns: [0, 1, 2, 4, 5, 6, 7, 8] }
                    }
                ],
                columnDefs: [
                    { targets: [13,14,15, 16, 17, 18, 19], visible: false }
                ],
                paging: true,
                ordering: true,
                scrollX: true,
                responsive: false,
                autoWidth: true,
                searching: false
            });

            // Custom filtering function for date
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                const selectedDate = $('#minDate').val(); // Format: yyyy-mm-dd
                const orderDateStr = data[1]; // Column index of OrderDate

                if (!selectedDate) return true;

                const selected = new Date(selectedDate);
                const orderDate = new Date(orderDateStr);

                // Compare by date only, ignore time
                return selected.toDateString() === orderDate.toDateString();
            });

            // Trigger redraw when filters change
            // $('#officeFilter, #minDate').on('change', function () {
            //     table.draw();
            // });
        });
    </script>

}
