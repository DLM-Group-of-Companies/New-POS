@page
@model NLI_POS.Pages.Report.DailySalesModel

@{
    ViewData["Title"] = "Daily Sales";
}
<div class="container-fluid bg-white bg-gradient  shadow p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary mb-0">
            <i class="fas fa-calendar-day me-2"></i> Daily Sales Report
        </h3>
        <i class="fas fa-window-close fa-2xl text-danger" role="button" title="Close" onclick="window.location = '../Index';"></i>
    </div>
    <hr />
    <div class="row g-3 mb-4">
        <form method="get" class="row g-2 align-items-end mb-4" onsubmit="return validateAndShowLoader(this)">
    <div class="col-md-3">
        <label for="officeFilter" class="form-label">Office</label>
        <select id="officeFilter" name="officeId" class="form-select" required>
            <option value="">Select Office</option>
            @foreach (var office in Model.OfficeList)
            {
                <option value="@office.Value"
                        data-timezone="@office.TimeZone"
                        data-currency="@office.CurrencyCode"
                                selected="@(office.Value == Model.Office ? "selected" : null)">
                    @office.Text
                </option>
            }
        </select>
                <input type="hidden" id="timeZoneInput" name="timeZone" />

    </div>
    <div class="col-md-2">
        <label for="dateFilter" class="form-label">Date</label>
@{
    var timeZoneId = Request.Query["timeZone"].ToString();

    TimeZoneInfo timeZone;
    DateTime localDate;

    try
    {
        timeZone = !string.IsNullOrWhiteSpace(timeZoneId)
            ? TimeZoneInfo.FindSystemTimeZoneById(timeZoneId)
            : TimeZoneInfo.FindSystemTimeZoneById("Asia/Manila"); // Fallback

        localDate = Model.Date.HasValue
            ? TimeZoneInfo.ConvertTimeFromUtc(Model.Date.Value, timeZone)
            : TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, timeZone);
    }
    catch
    {
        // Fallback in case of invalid time zone
        localDate = DateTime.UtcNow.AddHours(8);
    }
}
<input type="date" id="dateFilter" name="dDate" class="form-control"
       value="@localDate.ToString("yyyy-MM-dd")" required />

    </div>
    <div class="col-md-1">
        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-2"></i> Filter</button>
    </div>
</form>

    </div>

    <div class="table-responsive">
        <table id="ordersTable" class="table table-bordered table-hover table-sm small w-100 text-nowrap">
            <thead class="table-light text-center">
                <tr>
                    <th>Order No.</th>
                    <th>Order Date</th>
                    <th>Customer Code</th>
                    <th>Customer</th>
                    <th>Item No</th>
                    <th>Order Type</th>
                    <th>Product Category</th>
                    <th>Product</th>
                    <th>Product Combo</th>
                    <th>Office</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Amount</th>
                    <th>Payment Method</th>
                    <th>Ref No</th>
                    <th>Notes</th>
                    <th>Encode Date</th>
                    <th>Encoded By</th>
                    <th>Update Date</th>
                    <th>Updated By</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in Model.Order)
                {int itemNo = 1;
                    foreach (var item in order.ProductItems)
                    {                         
                        <tr>
                            <td>@order.OrderNo</td>
                            
                            <td>
                                    @{
                                        var tz = TimeZoneInfo.FindSystemTimeZoneById(Request.Query["timeZone"]);
                                        var vlocalDate = TimeZoneInfo.ConvertTimeFromUtc(order.OrderDate, tz);
                                    }
                                    @vlocalDate.ToString("yyyy-MM-dd")
                            </td>

                            <td>@order.Customers?.CustCode</td>
                            <td>@($"{order.Customers?.FirstName} {order.Customers?.LastName}")</td>
                            <td>@itemNo</td> 
                            <td>@order.OrderType</td>
                            <td>@item.ProductCat</td>
                            <td>@item.ProductName</td>
                            <td>@(@item.ComboName == "No Combination Available" ? "--" : @item.ComboName)</td>
                            <td>@order.Office?.Name</td>
                            <td>@item.Price.ToString("N2")</td>
                            <td>@item.Quantity</td>
                            <td>
                                @{
                                    var total = item.Price * item.Quantity;
                                }
                            @total.ToString("N2")</td>
                            <td>
                                @string.Join(", ", order.Payments.Select(p => p.PayMethod))
                            </td>
                            <td>
                                @string.Join(", ", order.Payments.Select(p => p.ReferenceNo))
                            </td>
                            <td>@order.Notes</td>
                            <td>@order.EncodeDate?.ToString("yyyy-MM-dd")</td>
                            <td>@order.EncodedBy</td>
                            <td>@order.UpdateDate?.ToString("yyyy-MM-dd")</td>
                            <td>@order.UpdatedBy</td>
                        </tr>
                        itemNo++;
                    }
                }
            </tbody>

        </table>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const table = $('#ordersTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        className: 'btn btn-outline-success',
                        exportOptions: {
                            columns: ':visible'
                        },
                        filename: function () {
                            const office = $('select[name="officeFilter"]').val() || 'AllOffices';
                            const date = $('#dDate').val() || new Date().toISOString().slice(0, 10);                            
                            return `DailySales_${office}_${date}`;
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        className: 'btn btn-outline-danger',
                        exportOptions: { columns: [0, 1, 2, 4, 5, 6, 7, 8] }
                    },
                    {
                        extend: 'print',
                        className: 'btn btn-outline-secondary',
                        exportOptions: { columns: [0, 1, 2, 4, 5, 6, 7, 8] }
                    }
                ],
                columnDefs: [
                    { targets: [9,13,14,15, 16, 17, 18, 19], visible: false }
                ],
                paging: true,
                ordering: true,
                scrollX: true,
                responsive: false,
                autoWidth: true,
                searching: false
            });
});
            

    </script>
<script>
    function syncTimeZoneBeforeSubmit() {
        const select = document.getElementById('officeFilter');
        const tz = select.options[select.selectedIndex].getAttribute('data-timezone');
        
        document.getElementById('timeZoneInput').value = tz;
    }

    // Attach to form
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form[method="get"]');
        if (form) {
            form.addEventListener('submit', syncTimeZoneBeforeSubmit);
        }

        // Set default value on page load
        syncTimeZoneBeforeSubmit();
    });
</script>


}
